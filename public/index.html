<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>FluentD WS Gateway</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            .conn-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: #6c757d;
                display: inline-block;
                vertical-align: middle;
                margin-right: 8px;
            }
            .event {
                background-color: var(--bs-body-bg);
                border: 1px solid var(--bs-border-color);
                border-radius: .5rem;
                padding: .5rem .75rem;
            }
            .meta {
                color: var(--bs-secondary-color);
                font-size: .8rem;
            }
            .filterItem {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: .5rem;
                padding: .5rem;
                border: 1px dashed var(--bs-border-color);
                border-radius: .5rem;
                margin-bottom: .5rem;
            }
            button.danger {
                color: var(--bs-danger);
                border: 1px solid rgba(220,53,69,.35);
                background: transparent;
                padding: .375rem .75rem;
                border-radius: .375rem;
            }
            button.primary {
                color: #fff;
                background-color: var(--bs-primary);
                border: 1px solid var(--bs-primary);
                padding: .375rem .75rem;
                border-radius: .375rem;
            }
            #events {
                height: 70vh;
                overflow: auto;
            }
            code {
                background: rgba(108,117,125,.1);
                padding: .1rem .35rem;
                border-radius: .25rem;
            }
        </style>
    </head>
    <body class="bg-body">
        <nav class="navbar bg-body-tertiary sticky-top border-bottom">
            <div class="container-fluid">
                <div class="d-flex align-items-center gap-2">
                    <span id="connDot" class="conn-dot"></span>
                    <strong id="connStatus" class="me-2">disconnected</strong>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <label for="wsUrl" class="form-label m-0 me-1">WS URL</label>
                    <input id="wsUrl" type="text" class="form-control form-control-sm" style="width: 320px;" placeholder="ws://localhost/" value="{{WS_URL}}">
                    <button id="reconnectBtn" class="btn btn-sm btn-primary">Reconnect</button>
                </div>
            </div>
        </nav>

        <main class="container my-3">
            <div class="row g-3">
                <div class="col-12 col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex gap-2 align-items-stretch mb-3">
                                <select id="modeSelect" class="form-select">
                                    <option value="OR" selected>OR</option>
                                    <option value="AND">AND</option>
                                </select>
                                <button id="togglePauseBtn" class="btn btn-outline-secondary w-100">â–¶ Start</button>
                            </div>

                            <div class="input-group mb-2">
                                <input id="exprInput" type="text" class="form-control" placeholder="Filter expression">
                                <button id="addFilterBtn" class="btn btn-outline-primary">Add filter</button>
                                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterHelpModal">?</button>
                            </div>

                            <div class="d-flex gap-2 mb-3">
                                <button id="clearFiltersBtn" class="btn btn-outline-danger">Clear filters</button>
                                <button id="flushBtn" class="btn btn-outline-secondary">Clear log</button>
                            </div>

                            <h6 class="text-secondary mb-2">Active filters</h6>
                            <div id="filterList"></div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <div id="events" class="d-flex flex-column-reverse gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div class="modal fade" id="filterHelpModal" tabindex="-1" aria-labelledby="filterHelpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterHelpModalLabel">JMESPath Filter Help</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>You can use JMESPath expressions to filter events. Select the logical mode (<strong>AND</strong> or <strong>OR</strong>) to control how multiple filters are combined:</p>
                        <ul>
                            <li><strong>AND:</strong> all filters must match for an event to pass</li>
                            <li><strong>OR:</strong> any filter match is enough for an event to pass</li>
                        </ul>

                        <p>Examples of filter's expression:</p>
                        <ul>
                            <li><strong>String equals:</strong> <code>euser_id == 'abcde'</code></li>
                            <li><strong>String not equals:</strong> <code>user_id != 'abcde'</code></li>
                            <li><strong>Number equals:</strong> <code>level == `123`</code></li>
                            <li><strong>Number greater than:</strong> <code>level > `123`</code></li>
                            <li><strong>Boolean true:</strong> <code>is_premium == `true`</code></li>
                            <li><strong>Boolean false:</strong> <code>is_vip == `false`</code></li>
                            <li><strong>Contains substring:</strong> <code>contains(fluentd_tag, 'user_spin_complete')</code></li>
                            <li><strong>Not contains substring:</strong> <code>!contains(fluentd_tag, 'user_wallet_change')</code></li>
                        </ul>
                        <p>
                            For full syntax reference, see:
                            <a href="https://jmespath.org/specification.html" target="_blank" rel="noopener noreferrer">JMESPath specification</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/eventLiveViewer.js"></script>
    </body>
</html>
